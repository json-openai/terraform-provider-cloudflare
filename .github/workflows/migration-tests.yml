name: Migration Tests
concurrency:
  group: migration-tests

on:
  workflow_dispatch:

env:
  CLOUDFLARE_ACCOUNT_ID: f037e56e89293a057740de681ac9abbe
  CLOUDFLARE_ALT_DOMAIN: terraform-alt.cfapi.net
  CLOUDFLARE_ALT_ZONE_ID: ed9caae55809bfe3209699f602ce17fc
  CLOUDFLARE_DOMAIN: terraform.cfapi.net
  CLOUDFLARE_ZONE_ID: 0da42c8d2132a9ddaf714f9e7c920711
  TF_MIGRATE_BINARY_PATH: ${{ github.workspace }}/tf-migrate
  TF_MIG_TEST: true
  TF_ACC: 1
  LAST_V4_VERSION: "4.52.5"
jobs:
  migration-tests:
    name: ${{ matrix.test.display_name }} Tests
    runs-on: ${{ github.repository == 'stainless-sdks/cloudflare-terraform' && 'depot-ubuntu-24.04' || 'lx64' }}
    strategy:
      fail-fast: false
      matrix:
        test:
          - name: magic
            display_name: Magic
            email: tf-acct-magic-magic@cfapi.net
            api_key_secret: TF_ACCT_MAGIC_MAGIC_API_KEY
          - name: organization
            display_name: Organization
            email: orgs-terraform-user@cfapi.net
            api_key_secret: CLOUDFLARE_ORG_API_KEY
            org_id: 48684ccf40084424e26b7c0ab79e09dc
          - name: zone-core
            display_name: Zone Core
            email: tf-acct-zone-zone-core@cfapi.net
            api_key_secret: TF_ACCT_ZONE_ZONE_CORE_API_KEY
          - name: zone-settings
            display_name: Zone Settings
            email: tf-acct-zone-zone-settings@cfapi.net
            api_key_secret: TF_ACCT_ZONE_ZONE_SETTINGS_API_KEY
          - name: dns
            display_name: DNS
            email: tf-acct-dns-dns@cfapi.net
            api_key_secret: TF_ACCT_DNS_DNS_API_KEY
          - name: load-balancing
            display_name: Load Balancing
            email: tf-acct-load-balancing-load-balancing@cfapi.net
            api_key_secret: TF_ACCT_LOAD_BALANCING_LOAD_BALANCING_API_KEY
          - name: workers-core
            display_name: Workers Core
            email: tf-acct-workers-workers-core@cfapi.net
            api_key_secret: TF_ACCT_WORKERS_WORKERS_CORE_API_KEY
          - name: workers-extended
            display_name: Workers Extended
            email: tf-acct-workers-workers-extended@cfapi.net
            api_key_secret: TF_ACCT_WORKERS_WORKERS_EXTENDED_API_KEY
          - name: workers-platform
            display_name: Workers Platform
            email: tf-acct-workers-workers-platform@cfapi.net
            api_key_secret: TF_ACCT_WORKERS_WORKERS_PLATFORM_API_KEY
          - name: email-routing
            display_name: Email Routing
            email: tf-acct-email-email-routing@cfapi.net
            api_key_secret: TF_ACCT_EMAIL_EMAIL_ROUTING_API_KEY
          - name: email-security
            display_name: Email Security
            email: tf-acct-email-email-security@cfapi.net
            api_key_secret: TF_ACCT_EMAIL_EMAIL_SECURITY_API_KEY
          - name: security-core
            display_name: Security Core
            email: tf-acct-security-security-core@cfapi.net
            api_key_secret: TF_ACCT_SECURITY_SECURITY_CORE_API_KEY
          - name: security-advanced
            display_name: Security Advanced
            email: tf-acct-security-security-advanced@cfapi.net
            api_key_secret: TF_ACCT_SECURITY_SECURITY_ADVANCED_API_KEY
          - name: rules-and-policies
            display_name: Rules and Policies
            email: tf-acct-rules-rules-and-policies@cfapi.net
            api_key_secret: TF_ACCT_RULES_RULES_AND_POLICIES_API_KEY
          - name: snippets
            display_name: Snippets
            email: tf-acct-snippets-snippets@cfapi.net
            api_key_secret: TF_ACCT_SNIPPETS_SNIPPETS_API_KEY
          - name: tls-and-certificates
            display_name: TLS and Certificates
            email: tf-acct-tls-tls-and-certificates@cfapi.net
            api_key_secret: TF_ACCT_TLS_TLS_AND_CERTIFICATES_API_KEY
          - name: ssl-config
            display_name: SSL Config
            email: tf-acct-ssl-ssl-config@cfapi.net
            api_key_secret: TF_ACCT_SSL_SSL_CONFIG_API_KEY
          - name: web-features
            display_name: Web Features
            email: tf-acct-web-web-features@cfapi.net
            api_key_secret: TF_ACCT_WEB_WEB_FEATURES_API_KEY
          - name: web-monitoring
            display_name: Web Monitoring
            email: tf-acct-web-web-monitoring@cfapi.net
            api_key_secret: TF_ACCT_WEB_WEB_MONITORING_API_KEY
          - name: waiting-room
            display_name: Waiting Room
            email: tf-acct-waiting-room-waiting-room@cfapi.net
            api_key_secret: TF_ACCT_WAITING_ROOM_WAITING_ROOM_API_KEY
          - name: performance
            display_name: Performance
            email: tf-acct-performance-performance@cfapi.net
            api_key_secret: TF_ACCT_PERFORMANCE_PERFORMANCE_API_KEY
          - name: cdn-advanced
            display_name: CDN Advanced
            email: tf-acct-cdn-cdn-advanced@cfapi.net
            api_key_secret: TF_ACCT_CDN_CDN_ADVANCED_API_KEY
          - name: gateway-and-policies
            display_name: Gateway and Policies
            email: tf-acct-zero-trust-gateway-and-policies@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_GATEWAY_AND_POLICIES_API_KEY
          - name: dlp-config
            display_name: DLP Config
            email: tf-acct-zero-trust-dlp-config@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_DLP_CONFIG_API_KEY
          - name: access-core
            display_name: Access Core
            email: tf-acct-zero-trust-access-core@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ACCESS_CORE_API_KEY
          - name: access-identity
            display_name: Access Identity
            email: tf-acct-zero-trust-access-identity@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ACCESS_IDENTITY_API_KEY
          - name: access-mtls
            display_name: Access mTLS
            email: tf-acct-zero-trust-access-mtls@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ACCESS_MTLS_API_KEY
          - name: access-applications
            display_name: Access Applications
            email: tf-acct-zero-trust-access-applications@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ACCESS_APPLICATIONS_API_KEY
          - name: zero-trust-org
            display_name: Zero Trust Organization
            email: tf-acct-zero-trust-zero-trust-org@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ZERO_TRUST_ORG_API_KEY
          - name: zero-trust-list
            display_name: Zero Trust List
            email: tf-acct-zero-trust-zero-trust-list@cfapi.net
            api_key_secret: TF_ACCT_ZERO_TRUST_ZERO_TRUST_LIST_API_KEY
          - name: tunnel-cloudflared
            display_name: Tunnel Cloudflared
            email: tf-acct-tunnel-tunnel-cloudflared@cfapi.net
            api_key_secret: TF_ACCT_TUNNEL_TUNNEL_CLOUDFLARED_API_KEY
          - name: tunnel-devices
            display_name: Tunnel Devices
            email: tf-acct-tunnel-tunnel-devices@cfapi.net
            api_key_secret: TF_ACCT_TUNNEL_TUNNEL_DEVICES_API_KEY
          - name: account-core
            display_name: Account Core
            email: tf-acct-account-account-core@cfapi.net
            api_key_secret: TF_ACCT_ACCOUNT_ACCOUNT_CORE_API_KEY
          - name: account-settings
            display_name: Account Settings
            email: tf-acct-account-account-settings@cfapi.net
            api_key_secret: TF_ACCT_ACCOUNT_ACCOUNT_SETTINGS_API_KEY
          - name: r2-storage
            display_name: R2 Storage
            email: tf-acct-storage-r2-storage@cfapi.net
            api_key_secret: TF_ACCT_STORAGE_R2_STORAGE_API_KEY
          - name: pages
            display_name: Pages
            email: tf-acct-pages-pages@cfapi.net
            api_key_secret: TF_ACCT_PAGES_PAGES_API_KEY
          - name: queue-and-messaging
            display_name: Queue and Messaging
            email: tf-acct-messaging-queue-and-messaging@cfapi.net
            api_key_secret: TF_ACCT_MESSAGING_QUEUE_AND_MESSAGING_API_KEY
          - name: general-api
            display_name: General API
            email: tf-acct-general-general-api@cfapi.net
            api_key_secret: TF_ACCT_GENERAL_GENERAL_API_API_KEY
          - name: misc-account-tools
            display_name: Misc Account Tools
            email: tf-acct-misc-misc-account-tools@cfapi.net
            api_key_secret: TF_ACCT_MISC_MISC_ACCOUNT_TOOLS_API_KEY
          - name: platform-and-advanced
            display_name: Platform and Advanced
            email: tf-acct-platform-platform-and-advanced@cfapi.net
            api_key_secret: TF_ACCT_PLATFORM_PLATFORM_AND_ADVANCED_API_KEY
          - name: default
            display_name: Default
            email: tf-acct-default-default@cfapi.net
            api_key_secret: TF_ACCT_DEFAULT_DEFAULT_API_KEY
    env:
      CLOUDFLARE_EMAIL: ${{ matrix.test.email }}
      CLOUDFLARE_API_KEY: ${{ secrets[matrix.test.api_key_secret] }}
      CLOUDFLARE_ORGANIZATION_ID: ${{ matrix.test.org_id || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go.mod

      - name: Bootstrap
        run: ./scripts/bootstrap

      - name: Checkout tf-migrate
        uses: actions/checkout@v4
        with:
          repository: cloudflare/tf-migrate
          path: tf-migrate-src

      - name: Build tf-migrate
        run: |
          cd tf-migrate-src
          go build -o ../tf-migrate ./cmd/tf-migrate

      - name: Run ${{ matrix.test.display_name }} Tests
        run: ./scripts/run-ci-tests ${{ matrix.test.name }} migration

  check-results:
    name: Check Test Results
    runs-on: ubuntu-latest
    needs: migration-tests
    if: always()
    steps:
      - name: Check if any tests failed
        run: |
          echo "Checking test results..."
          if [ "${{ needs.migration-tests.result }}" == "failure" ]; then
            echo "One or more tests failed"
            exit 1
          else
            echo "All tests passed or were skipped"
          fi
